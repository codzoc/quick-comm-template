name: Update from template

# This workflow automatically updates your repository with the latest changes
# from the original template. It runs weekly or can be triggered manually.

on:
  # Manual trigger from Actions tab - click "Run workflow"
  workflow_dispatch:

  # Automatic weekly updates every Monday at 9 AM UTC
  # Comment out the schedule section if you prefer manual-only updates
  schedule:
    - cron: '0 9 * * 1'

# Minimal permissions for safety
permissions:
  contents: write
  pull-requests: write
  issues: write  # Required for gh CLI to create PRs

jobs:
  update-from-template:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote and fetch updates
        run: |
          # Add the original template repository as upstream
          git remote add upstream https://github.com/codzoc/quick-comm-template.git || true

          # Fetch the latest changes from upstream
          git fetch upstream main

          echo "‚úÖ Fetched latest updates from template repository"

      - name: Check for updates
        id: check-updates
        run: |
          # Check if there are differences between local main and upstream main
          if git diff --quiet main upstream/main; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No updates available - your repo is already up to date!"
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Updates available from template"
          fi

      - name: Attempt automatic merge
        if: steps.check-updates.outputs.has_updates == 'true'
        id: auto-merge
        continue-on-error: true
        run: |
          # Try to merge upstream changes (allow unrelated histories for repos created before workflow existed)
          if git merge upstream/main --allow-unrelated-histories --no-edit -m "chore: update from template repository

          Updates from codzoc/quick-comm-template

          This automated update brings the latest improvements, bug fixes, and features from the original template.

          ü§ñ Generated by Update from template workflow"; then
            echo "merge_success=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Successfully merged upstream changes"
          else
            # Merge failed due to conflicts
            git merge --abort 2>/dev/null || true
            echo "merge_success=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Automatic merge failed due to conflicts"
          fi

      - name: Preserve workflow files (for direct push)
        if: steps.check-updates.outputs.has_updates == 'true' && steps.auto-merge.outputs.merge_success == 'true'
        run: |
          # Restore workflow files from HEAD to prevent GITHUB_TOKEN permission issues
          # GitHub doesn't allow GITHUB_TOKEN to modify workflow files for security
          git checkout HEAD -- .github/workflows/ || true

          echo "‚úÖ Preserved existing workflow files (not updated from template)"
          echo "‚ÑπÔ∏è Workflow updates must be applied manually for security reasons"

      - name: Push updates to main
        if: steps.check-updates.outputs.has_updates == 'true' && steps.auto-merge.outputs.merge_success == 'true'
        run: |
          git push origin main
          echo "‚úÖ Successfully pushed updates to main branch"

      - name: Create conflict resolution branch
        if: steps.check-updates.outputs.has_updates == 'true' && steps.auto-merge.outputs.merge_success == 'false'
        id: conflict-branch
        run: |
          # Create a timestamped branch for conflict resolution
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="update-from-template-${TIMESTAMP}"

          # Create and checkout the new branch
          git checkout -b "${BRANCH_NAME}"

          # Save branch name for later steps
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "üìù Created conflict resolution branch: ${BRANCH_NAME}"

      - name: Merge with conflict markers (for PR)
        if: steps.check-updates.outputs.has_updates == 'true' && steps.auto-merge.outputs.merge_success == 'false'
        run: |
          # Attempt merge again (will fail, but creates conflict markers)
          git merge upstream/main --allow-unrelated-histories --no-edit -m "chore: update from template repository

          Updates from codzoc/quick-comm-template

          ü§ñ Generated by Update from template workflow
          ‚ö†Ô∏è This merge has conflicts that need manual resolution" || true

          # Get list of conflicted files
          CONFLICTED_FILES=$(git diff --name-only --diff-filter=U || echo "Unable to determine conflicted files")
          echo "conflicted_files<<EOF" >> $GITHUB_ENV
          echo "$CONFLICTED_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "‚ö†Ô∏è Files with conflicts:"
          echo "$CONFLICTED_FILES"

      - name: Preserve workflow files (for PR)
        if: steps.check-updates.outputs.has_updates == 'true' && steps.auto-merge.outputs.merge_success == 'false'
        run: |
          # Restore workflow files from HEAD to prevent GITHUB_TOKEN permission issues
          git checkout HEAD -- .github/workflows/ || true
          echo "‚úÖ Preserved existing workflow files"

      - name: Commit conflict markers
        if: steps.check-updates.outputs.has_updates == 'true' && steps.auto-merge.outputs.merge_success == 'false'
        run: |
          # Add all changes (including conflict markers)
          git add .

          # Commit the conflicted state
          git commit -m "chore: update from template repository (conflicts to resolve)

          Updates from codzoc/quick-comm-template

          ‚ö†Ô∏è This merge has conflicts that need manual resolution.
          Please review the files marked with conflicts and resolve them.

          ü§ñ Generated by Update from template workflow" || echo "No changes to commit"

      - name: Push conflict resolution branch
        if: steps.check-updates.outputs.has_updates == 'true' && steps.auto-merge.outputs.merge_success == 'false'
        run: |
          git push origin ${{ steps.conflict-branch.outputs.branch_name }}
          echo "‚úÖ Pushed conflict resolution branch"

      - name: Create Pull Request for conflict resolution
        if: steps.check-updates.outputs.has_updates == 'true' && steps.auto-merge.outputs.merge_success == 'false'
        id: create-pr
        run: |
          PR_BODY=$(cat <<'EOF'
          ## ‚ö†Ô∏è Template Update - Conflicts Need Resolution

          This PR contains updates from the [quick-comm-template](https://github.com/codzoc/quick-comm-template) repository, but **automatic merge failed due to conflicts**.

          ### üîç What Happened

          The workflow tried to automatically merge the latest template changes into your `main` branch, but some files have conflicts that need your attention.

          ### üìã Files with Conflicts

          The following files have merge conflicts:

          ```
          ${{ env.conflicted_files }}
          ```

          ### ‚úÖ How to Resolve Conflicts

          **Option 1: Resolve in GitHub (Easiest)**

          1. Click the **"Resolve conflicts"** button above
          2. GitHub will show you each conflicting file
          3. Edit the files to keep the changes you want
          4. Remove the conflict markers (`<<<<<<<`, `=======`, `>>>>>>>`)
          5. Click **"Mark as resolved"** for each file
          6. Click **"Commit merge"**
          7. Merge this PR

          **Option 2: Resolve Locally**

          1. Clone your repository: `git clone <your-repo-url>`
          2. Checkout this branch: `git checkout ${{ steps.conflict-branch.outputs.branch_name }}`
          3. Resolve conflicts in your editor
          4. Stage changes: `git add .`
          5. Commit: `git commit -m "Resolve merge conflicts"`
          6. Push: `git push origin ${{ steps.conflict-branch.outputs.branch_name }}`
          7. Merge this PR

          ### üéØ What's Being Updated

          This update brings you:
          - ‚ú® New features and improvements
          - üêõ Bug fixes
          - üìö Documentation updates
          - üîß Configuration enhancements

          ### üí° Understanding Conflict Markers

          In conflicted files, you'll see markers like this:

          ```
          <<<<<<< HEAD
          Your current code
          =======
          Template's new code
          >>>>>>> upstream/main
          ```

          - Keep the code you want (yours, template's, or a combination)
          - Delete the conflict markers
          - Save the file

          ### üõ°Ô∏è Safety Notes

          - **Workflow files** (`.github/workflows/`) are **preserved** - not updated
          - You can always close this PR if you don't want the updates
          - Your customizations in `src/config/business.js`, `src/config/theme.js`, etc. should be kept

          ---

          ü§ñ This PR was automatically created by the **Update from template** workflow.
          EOF
          )

          # Create PR using GitHub CLI (without labels since they may not exist)
          PR_URL=$(gh pr create \
            --base main \
            --head ${{ steps.conflict-branch.outputs.branch_name }} \
            --title "‚ö†Ô∏è Update from template (conflicts need resolution)" \
            --body "$PR_BODY")

          echo "pull-request-url=$PR_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Pull Request created: $PR_URL"

          # Try to add labels if they exist (won't fail if they don't)
          gh pr edit "$PR_URL" --add-label "template-update" 2>/dev/null || echo "Label 'template-update' not found, skipping"
          gh pr edit "$PR_URL" --add-label "conflicts" 2>/dev/null || echo "Label 'conflicts' not found, skipping"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Workflow summary
        if: always()
        run: |
          if [ "${{ steps.check-updates.outputs.has_updates }}" = "false" ]; then
            echo "### ‚úÖ Already Up to Date" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your repository is already up to date with the template!" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.auto-merge.outputs.merge_success }}" = "true" ]; then
            echo "### üéâ Successfully Updated!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your main branch has been automatically updated with the latest changes from the template." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**What was updated:**" >> $GITHUB_STEP_SUMMARY
            echo "- ‚ú® New features and improvements" >> $GITHUB_STEP_SUMMARY
            echo "- üêõ Bug fixes" >> $GITHUB_STEP_SUMMARY
            echo "- üìö Documentation updates" >> $GITHUB_STEP_SUMMARY
            echo "- üîß Configuration enhancements" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your store is now running the latest version! üöÄ" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ö†Ô∏è Conflicts Detected - PR Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Automatic update failed due to merge conflicts, but don't worry!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**A Pull Request has been created for you:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.create-pr.outputs.pull-request-url }}" != "" ]; then
              echo "üëâ [View and resolve conflicts in PR](${{ steps.create-pr.outputs.pull-request-url }})" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            echo "**To resolve:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Open the Pull Request" >> $GITHUB_STEP_SUMMARY
            echo "2. Click **'Resolve conflicts'** button" >> $GITHUB_STEP_SUMMARY
            echo "3. Edit files in GitHub's editor" >> $GITHUB_STEP_SUMMARY
            echo "4. Mark as resolved and commit" >> $GITHUB_STEP_SUMMARY
            echo "5. Merge the PR" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No local git needed - resolve everything in your browser! üéâ" >> $GITHUB_STEP_SUMMARY
          fi
