name: Update from template

# This workflow automatically updates your repository with the latest changes
# from the original template. It runs weekly or can be triggered manually.

on:
  # Manual trigger from Actions tab - click "Run workflow"
  workflow_dispatch:

  # Automatic weekly updates every Monday at 9 AM UTC
  # Comment out the schedule section if you prefer manual-only updates
  schedule:
    - cron: '0 9 * * 1'

# Minimal permissions for safety
permissions:
  contents: write

jobs:
  update-from-template:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote and fetch updates
        run: |
          # Add the original template repository as upstream
          git remote add upstream https://github.com/codzoc/quick-comm-template.git || true

          # Fetch the latest changes from upstream
          git fetch upstream main

          echo "âœ… Fetched latest updates from template repository"

      - name: Check for updates
        id: check-updates
        run: |
          # Check if there are differences between local main and upstream main
          if git diff --quiet main upstream/main; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No updates available - your repo is already up to date!"
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "âœ… Updates available from template"
          fi

      - name: Attempt automatic merge
        if: steps.check-updates.outputs.has_updates == 'true'
        id: auto-merge
        continue-on-error: true
        run: |
          # Try to merge upstream changes
          if git merge upstream/main --no-edit -m "chore: update from template repository

          Updates from codzoc/quick-comm-template

          This automated update brings the latest improvements, bug fixes, and features from the original template.

          ðŸ¤– Generated by Update from template workflow"; then
            echo "merge_success=true" >> $GITHUB_OUTPUT
            echo "âœ… Successfully merged upstream changes"
          else
            # Merge failed due to conflicts
            git merge --abort
            echo "merge_success=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Automatic merge failed due to conflicts"
          fi

      - name: Preserve workflow files
        if: steps.check-updates.outputs.has_updates == 'true' && steps.auto-merge.outputs.merge_success == 'true'
        run: |
          # Restore workflow files from HEAD to prevent GITHUB_TOKEN permission issues
          # GitHub doesn't allow GITHUB_TOKEN to modify workflow files for security
          git checkout HEAD -- .github/workflows/ || true

          echo "âœ… Preserved existing workflow files (not updated from template)"
          echo "â„¹ï¸ Workflow updates must be applied manually for security reasons"

      - name: Push updates to main
        if: steps.check-updates.outputs.has_updates == 'true' && steps.auto-merge.outputs.merge_success == 'true'
        run: |
          git push origin main
          echo "âœ… Successfully pushed updates to main branch"

      - name: Notify about conflicts
        if: steps.check-updates.outputs.has_updates == 'true' && steps.auto-merge.outputs.merge_success == 'false'
        run: |
          echo "âš ï¸ Unable to automatically update due to conflicts"
          echo ""
          echo "Manual intervention required:"
          echo "1. Clone your repository locally"
          echo "2. Run: git fetch upstream main"
          echo "3. Run: git merge upstream/main"
          echo "4. Resolve conflicts manually"
          echo "5. Commit and push to main"
          exit 1

      - name: Workflow summary
        if: always()
        run: |
          if [ "${{ steps.check-updates.outputs.has_updates }}" = "false" ]; then
            echo "### âœ… Already Up to Date" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your repository is already up to date with the template!" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.auto-merge.outputs.merge_success }}" = "true" ]; then
            echo "### ðŸŽ‰ Successfully Updated!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your main branch has been automatically updated with the latest changes from the template." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**What was updated:**" >> $GITHUB_STEP_SUMMARY
            echo "- âœ¨ New features and improvements" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ› Bug fixes" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“š Documentation updates" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”§ Configuration enhancements" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your store is now running the latest version! ðŸš€" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Manual Update Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Automatic update failed due to merge conflicts." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**To update manually:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Clone your repository locally" >> $GITHUB_STEP_SUMMARY
            echo "2. Run: \`git remote add upstream https://github.com/codzoc/quick-comm-template.git\`" >> $GITHUB_STEP_SUMMARY
            echo "3. Run: \`git fetch upstream main\`" >> $GITHUB_STEP_SUMMARY
            echo "4. Run: \`git merge upstream/main\`" >> $GITHUB_STEP_SUMMARY
            echo "5. Resolve conflicts in the files listed" >> $GITHUB_STEP_SUMMARY
            echo "6. Commit and push to main" >> $GITHUB_STEP_SUMMARY
          fi
