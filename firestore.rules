rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated admin
    function isAdmin() {
      return request.auth != null;
    }

    // Helper function to validate required fields
    function hasRequiredFields(data, fields) {
      return fields.toSet().difference(data.keys().toSet()).size() == 0;
    }

    // Products collection
    // Public: read (view products)
    // Admin: full access (CRUD)
    match /products/{productId} {
      allow read: if true;

      allow create: if isAdmin()
        && hasRequiredFields(request.resource.data, ['title', 'description', 'price', 'imagePath', 'stock'])
        && request.resource.data.title is string
        && request.resource.data.description is string
        && request.resource.data.price is number
        && request.resource.data.price >= 0
        && request.resource.data.stock is number
        && request.resource.data.stock >= 0;

      allow update: if isAdmin()
        && request.resource.data.keys().hasAny(['title', 'description', 'price', 'discountedPrice', 'imagePath', 'stock', 'updatedAt']);

      allow delete: if isAdmin();
    }

    // Orders collection
    // Public: create only (customers can place orders with validation)
    // Admin: read, update (manage orders)
    match /orders/{orderId} {
      allow create: if request.resource.data.keys().hasAll(['orderId', 'items', 'customer', 'status', 'total'])
        && request.resource.data.items is list
        && request.resource.data.items.size() > 0
        && request.resource.data.customer.keys().hasAll(['name', 'phone', 'address', 'pin'])
        && request.resource.data.customer.name is string
        && request.resource.data.customer.phone is string
        && request.resource.data.total is number
        && request.resource.data.total >= 0
        && request.resource.data.status == 'pending';

      allow read: if isAdmin();

      allow update: if isAdmin()
        && request.resource.data.status in ['pending', 'processing', 'completed', 'cancelled'];
    }

    // Settings collection (about, terms, privacy static pages)
    // Public: read
    // Admin: read, write
    match /settings/{settingId} {
      allow read: if true;

      allow write: if isAdmin()
        && settingId in ['about', 'terms', 'privacy']
        && request.resource.data.keys().hasAny(['content', 'imagePath', 'updatedAt']);
    }

    // Store info collection (contact details, social media)
    // Public: read
    // Admin: read, write
    match /storeInfo/{infoId} {
      allow read: if true;

      allow write: if isAdmin()
        && infoId == 'contact'
        && request.resource.data.keys().hasAny(['storeName', 'phone', 'whatsapp', 'facebook', 'instagram', 'youtube', 'updatedAt']);
    }
  }
}
